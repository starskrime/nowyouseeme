{% extends 'dashboard/base.html' %}

{% block title %}{{ contact.email }} - Retention Analytics{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Contact Details</h1>
    <a href="/admin/tracking/contact/{{ contact.id }}/change/" class="btn btn-outline-secondary">
        <i class="bi bi-pencil"></i> Edit
    </a>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><h5 class="mb-0">Contact Information</h5></div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>Email:</th>
                        <td>{{ contact.email }}</td>
                    </tr>
                    <tr>
                        <th>Name:</th>
                        <td>{{ contact.name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Phone:</th>
                        <td>{{ contact.phone|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>LinkedIn:</th>
                        <td>
                            {% if contact.linkedin_url %}
                                <a href="{{ contact.linkedin_url }}" target="_blank">View Profile</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Facebook:</th>
                        <td>
                            {% if contact.facebook_url %}
                                <a href="{{ contact.facebook_url }}" target="_blank">View Profile</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Site:</th>
                        <td><a href="{% url 'dashboard:site-detail' contact.site.id %}">{{ contact.site.name }}</a></td>
                    </tr>
                    <tr>
                        <th>First Identified:</th>
                        <td>{{ contact.created_at|date:"M d, Y H:i" }}</td>
                    </tr>
                    <tr>
                        <th>Last Updated:</th>
                        <td>{{ contact.updated_at|date:"M d, Y H:i" }}</td>
                    </tr>
                    {% if contact.visitor.matched_via %}
                    <tr>
                        <th>Identification Method:</th>
                        <td>
                            <span class="badge bg-info">
                            {% if contact.visitor.matched_via == 'browser_fingerprint' %}
                                Browser Fingerprint
                            {% elif contact.visitor.matched_via == 'ip_address' %}
                                IP Address
                            {% elif contact.visitor.matched_via == 'user_agent' %}
                                User Agent
                            {% elif contact.visitor.matched_via == 'email' %}
                                Email
                            {% else %}
                                {{ contact.visitor.matched_via }}
                            {% endif %}
                            </span>
                            {% if contact.extra_data.match_details %}
                                <br><small class="text-muted">
                                    {% if contact.visitor.matched_via == 'browser_fingerprint' %}
                                        <strong>Matched:</strong> {{ contact.extra_data.match_details.browser }} on {{ contact.extra_data.match_details.os }} ({{ contact.extra_data.match_details.device }}, {{ contact.extra_data.match_details.resolution }})
                                    {% elif contact.visitor.matched_via == 'ip_address' %}
                                        <strong>Matched IP:</strong> {{ contact.extra_data.match_details.ip }}
                                    {% elif contact.visitor.matched_via == 'user_agent' %}
                                        <strong>Matched User Agent:</strong> {{ contact.extra_data.match_details.user_agent|truncatechars:60 }}
                                    {% elif contact.visitor.matched_via == 'email' %}
                                        <strong>Identified by:</strong> User provided email
                                    {% endif %}
                                </small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </table>

                {% if contact.enrichment_data %}
                <hr>
                <h6>Enrichment Data:</h6>
                <table class="table table-sm">
                    <tr>
                        <th>First Name:</th>
                        <td>{{ contact.enrichment_data.first_name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Last Name:</th>
                        <td>{{ contact.enrichment_data.last_name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Enrichment Email:</th>
                        <td>{{ contact.enrichment_data.email|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Enrichment Phone:</th>
                        <td>{{ contact.enrichment_data.phone|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Company:</th>
                        <td>{{ contact.enrichment_data.company|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Job Title:</th>
                        <td>{{ contact.enrichment_data.job_title|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Location:</th>
                        <td>{{ contact.enrichment_data.location|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>LinkedIn (Enriched):</th>
                        <td>
                            {% if contact.enrichment_data.linkedin_url %}
                                <a href="{{ contact.enrichment_data.linkedin_url }}" target="_blank">{{ contact.enrichment_data.linkedin_url }}</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Facebook (Enriched):</th>
                        <td>
                            {% if contact.enrichment_data.facebook_url %}
                                <a href="{{ contact.enrichment_data.facebook_url }}" target="_blank">{{ contact.enrichment_data.facebook_url }}</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Twitter (Enriched):</th>
                        <td>
                            {% if contact.enrichment_data.twitter_url %}
                                <a href="{{ contact.enrichment_data.twitter_url }}" target="_blank">{{ contact.enrichment_data.twitter_url }}</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Known IP Addresses:</th>
                        <td>
                            {% if contact.enrichment_data.ip_addresses %}
                                {% for ip in contact.enrichment_data.ip_addresses %}
                                    <span class="badge bg-secondary">{{ ip }}</span>{% if not forloop.last %} {% endif %}
                                {% endfor %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Source:</th>
                        <td><span class="badge bg-info">{{ contact.enrichment_data.source }}</span></td>
                    </tr>
                    <tr>
                        <th>Enrichment Created:</th>
                        <td>{{ contact.enrichment_data.created_at|date:"M d, Y H:i" }}</td>
                    </tr>
                    <tr>
                        <th>Enrichment Updated:</th>
                        <td>{{ contact.enrichment_data.updated_at|date:"M d, Y H:i" }}</td>
                    </tr>
                </table>
                {% endif %}

                {% if contact.extra_data %}
                <hr>
                <h6>Additional Data:</h6>
                <table class="table table-sm">
                    {% for key, value in contact.extra_data.items %}
                    <tr>
                        <th style="width: 40%;">{{ key|title }}:</th>
                        <td>
                            {% if value is not None %}
                                {{ value }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><h5 class="mb-0">Visitor Information</h5></div>
            <div class="card-body">
                {% if contact.visitor %}
                <table class="table table-sm">
                    <tr>
                        <th>Visitor ID:</th>
                        <td><a href="{% url 'dashboard:visitor-detail' contact.visitor.id %}">{{ contact.visitor.visitor_id }}</a></td>
                    </tr>
                    <tr>
                        <th>IP Address:</th>
                        <td><code>{{ contact.visitor.ip_address|default:"-" }}</code></td>
                    </tr>
                    <tr>
                        <th>User Agent:</th>
                        <td style="font-size: 0.85em;">{{ contact.visitor.user_agent|default:"-"|truncatechars:60 }}</td>
                    </tr>
                    <tr>
                        <th>Referrer:</th>
                        <td>{{ contact.visitor.referrer|default:"-"|truncatechars:50 }}</td>
                    </tr>
                    <tr>
                        <th>First Seen:</th>
                        <td>{{ contact.visitor.first_seen|date:"M d, Y H:i" }}</td>
                    </tr>
                    <tr>
                        <th>Last Seen:</th>
                        <td>{{ contact.visitor.last_seen|date:"M d, Y H:i" }}</td>
                    </tr>
                    <tr>
                        <th>Total Events:</th>
                        <td><span class="badge bg-primary">{{ event_count }}</span></td>
                    </tr>
                    <tr>
                        <th>Matched Via:</th>
                        <td>
                            {% if contact.visitor.matched_via %}
                                <span class="badge bg-success">{{ contact.visitor.matched_via }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                </table>

                <hr>
                <h6>Browser & Device:</h6>
                <table class="table table-sm">
                    <tr>
                        <th>Browser:</th>
                        <td>{{ contact.visitor.browser_name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>OS:</th>
                        <td>{{ contact.visitor.os_name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Device Type:</th>
                        <td>{{ contact.visitor.device_type|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Screen Resolution:</th>
                        <td>{{ contact.visitor.screen_resolution|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Timezone:</th>
                        <td>{{ contact.visitor.timezone|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Language:</th>
                        <td>{{ contact.visitor.language|default:"-" }}</td>
                    </tr>
                </table>

                {% if contact.visitor.utm_source or contact.visitor.utm_medium or contact.visitor.utm_campaign %}
                <hr>
                <h6>First-Touch Attribution (UTM):</h6>
                <table class="table table-sm">
                    <tr>
                        <th>Source:</th>
                        <td>{{ contact.visitor.utm_source|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Medium:</th>
                        <td>{{ contact.visitor.utm_medium|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Campaign:</th>
                        <td>{{ contact.visitor.utm_campaign|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Term:</th>
                        <td>{{ contact.visitor.utm_term|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Content:</th>
                        <td>{{ contact.visitor.utm_content|default:"-" }}</td>
                    </tr>
                </table>
                {% endif %}
                {% else %}
                <p class="text-muted">No visitor linked.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header"><h5 class="mb-0">Event History (Latest {{ events|length }})</h5></div>
    <div class="card-body">
        {% if events %}
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Page</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events %}
                        <tr>
                            <td><span class="badge bg-primary">{{ event.event_type }}</span></td>
                            <td>{{ event.page_title|default:event.page_url|truncatechars:60 }}</td>
                            <td>{{ event.timestamp|date:"M d, Y H:i:s" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted">No events recorded.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
